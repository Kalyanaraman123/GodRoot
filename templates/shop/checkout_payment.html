{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h2>Pay</h2>
    <p>Amount: â‚¹{{ order.total_amount }}</p>

    {# Put Razorpay values into a small data container so JS reads them cleanly #}
    <div id="rzp-data"
         data-key="{{ key_id }}"
         data-amount="{{ razor_order.amount }}"
         data-order-id="{{ razor_order.id }}">
    </div>

    <button id="rzp-button" class="btn">Pay with Razorpay</button>
</div>
{% endblock %}

{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
(function(){
  // Read values from the DOM (no Django tags inside JS)
  const el = document.getElementById('rzp-data');
  if (!el) return console.error('Razorpay data not found');

  const key = el.dataset.key || '';
  const amount = parseInt(el.dataset.amount || '0', 10); // amount in paise (integer)
  const orderId = el.dataset.orderId || '';

  const options = {
    key: key,
    amount: amount,     // amount in paise (Razorpay expects integer)
    currency: 'INR',
    order_id: orderId,
    handler: function (response) {
      // post the response to server for verification
      // we're using fetch instead of jQuery to avoid requiring it here
      fetch('/payment/verify/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(response)
      })
      .then(resp => resp.json())
      .then(data => {
        // handle server response
        if (data.status === 'ok') {
          window.location = '/'; // or order success page
        } else {
          alert('Payment verification failed');
        }
      })
      .catch(err => {
        console.error('payment verify error', err);
        alert('Payment verification error');
      });
    }
  };

  // create Razorpay instance
  const rzp = new Razorpay(options);

  // bind button
  document.getElementById('rzp-button').addEventListener('click', function(e){
    e.preventDefault();
    rzp.open();
  });

  // helper to read CSRF cookie (Django default)
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
})();
</script>
{% endblock %}
